---
title: "Cash Flow Analysis"
author: "Act. Bernardo Mondragon Brozon"
date: "January 16, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r economical assumptions}
t <- 10
y <- 0.08
r <- -0.02
```

\section{Assumptions}

The cash flow analysis will consist of computing the present value of the future revenue of all projects that the company will generate in the following $`r t`$ years withx   the following assumptions:

\begin{itemize}
\item Risk free annual effective interest rate of Mexican economy: `r y`.
\item Sustained price annual increment ratio of technology: `r r`.
\end{itemize}

The company will work on $5$ types of projects at the same time:

\begin{enumerate}
\item Landing pages,
\item Small projects,
\item Medium projects,
\item Large projects, and
\item Inhouse projects.
\end{enumerate}

Each type of project will arrive to the company according a Poisson point process with a given ratio $\lambda$ per year.

```{r functions}
getProjectPresentValue <- function(
  t,# Lifetime of the company
  # Mexican economy
  y, # Annual interest rate
  r, # Inflation rate
  # Princing of the project
  average.price, # Expected price of the project
  sd.price, # Standar deviation of the price of the project
  minimum.price, # Minimum price accepted for the project
  average.development.months, # Expected development time of the project measured in months
  lambda.po, # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate, # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate, # Percentage of the final price that is paid during the development of the project
  final.charge.rate, # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate # Percentaje of the price of the project to be charged monthly for project maintenance
) {
  # Calculate monthly effective interest rate
  y12 <- (1+y)^(1/12)-1
  
  time <- 0
  arrival.time <- 0
  interarrivals <- c()
  arrivals <- c()
  adjusted.prices <- c()
  present.values <- c()
  # Simulate projects arrivals
  while (time < t) {
    interarrival.time <- rexp(n=1, rate=lambda.po)
    time <- time + interarrival.time 
    if (time < t) {
      interarrivals <- c(interarrivals, interarrival.time)
      arrival.time <- arrival.time + interarrival.time
      arrivals <- c(arrivals, arrival.time)
      # Compute the present value of the project that just came in
      price <- rnorm(1, mean=average.price, sd=sd.price)-rgamma(1, shape=2, rate=0.6)*1000
      price <- max(minimum.price, price)
      # Adjust price with inflation rate
      adjusted.price <- price*(1+r)^arrival.time
      adjusted.prices <- c(adjusted.prices, adjusted.price)
      # Payment scheme
      advance.charge <- adjusted.price*advance.charge.rate
      during.development.charge <- adjusted.price*during.development.charge.rate
      final.charge <- adjusted.price*final.charge.rate
      monthly.rent <- adjusted.price*monthly.rent.rate
      # Simulate development time in months
      development.time <- rlnorm(1, meanlog=0, sdlog=0.25)*average.development.months
      months <- ceiling(development.time)
      monthly.payment <- during.development.charge/months
      time.to.end <- t - (arrival.time + months/12)
      time.to.end <- max(0, time.to.end)
      months.to.end <- ceiling(time.to.end*12)
      # Compute present values based on payment scheme
      discount.factor <- (1/(1+y))^arrival.time
      fractional.annuity <- ((1-(1/(1+y12))^months)/y12)
      advance.charge.present.value <- discount.factor*advance.charge
      monthly.charges.present.value <- discount.factor*monthly.payment*fractional.annuity
      final.payment.present.value <- discount.factor*((1/(1+y))^(development.time/12))*final.charge
      monthly.rents.present.value <- discount.factor*((1/(1+y))^(development.time/12))*monthly.rent*((1-(1/(1+y12))^(months.to.end))/y12)
      # Compute total present value
      present.value <- advance.charge.present.value + monthly.charges.present.value + final.payment.present.value + monthly.rents.present.value
      present.values <- c(present.values, present.value)
    }
  }
  
  ggplot(data=data.frame(arrivals, adjusted.prices), aes(x=arrivals, y=adjusted.prices)) +
    geom_point(color="blue", size=0.5) + ylim(c(0,max(adjusted.prices)+1000)) +
    geom_bar(stat="identity", color="#00AFBB", size=.1, alpha=.1, na.rm=TRUE) +
    geom_hline(yintercept=mean(adjusted.prices), size=1, color="cyan") +
    labs(x="Time (years)", y="Money")
  
  sum(present.values)
}

getInhouseProjectPresentValue <- function(
  t, # Lifetime of the company
  # Mexican economy
  y, # Annual interest rate
  r, # Inflation rate
  # Project details
  lambda.po, # Expected number of projects developed in a year
  average.development.months, # Expected development time of the project measured in months
  # Revenue scheme
  average.monthly.rent, # Expected value of the monthly rent that the project will generate
  sd.monthly.rent # Standar deviation of the monthly rent that the project will generate
) {
  # Calculate monthly effective interest rate
  y12 <- (1+y)^(1/12)-1
  
  time <- 0
  arrival.time <- 0
  interarrivals <- c()
  arrivals <- c()
  adjusted.prices <- c()
  present.values <- c()
  # Simulate projects arrivals
  while (time < t) {
    interarrival.time <- rexp(n=1, rate=lambda.po)
    time <- time + interarrival.time 
    if (time < t) {
      interarrivals <- c(interarrivals, interarrival.time)
      arrival.time <- arrival.time + interarrival.time
      arrivals <- c(arrivals, arrival.time)
      # Get development time
      development.time <- rlnorm(1, meanlog=0, sdlog=0.25)*average.development.months
      months <- ceiling(development.time)
      time.to.end <- t - arrival.time - months/12
      months.to.end <- ceiling(time.to.end*12)
      monthly.rent <- rnorm(1, mean=average.monthly.rent, sd=sd.monthly.rent)
      monthly.rent <- max(0, monthly.rent)
      # Compute present values
      discount.factor <- (1/(1+y))^arrival.time
      monthly.rents.present.value <- discount.factor*monthly.rent*((1-(1/(1+y12))^(months.to.end))/y12)
      present.value <- monthly.rents.present.value
      present.values <- c(present.values, present.value)
    }
  }
  sum(present.values)
}
```

\section{Landing pages}

```{r lading pages assumptions}
  t=10 # Lifetime of the company
  # Mexican economy
  y=0.1 # Annual interest rate
  r=-0.02 # Inflation rate
  # Princing of the project
  average.price=10000 # Expected price of the project
  sd.price=2000 # Standar deviation of the price of the project
  minimum.price=7000 # Minimum price accepted for the project
  average.development.months=1 # Expected development time of the project measured in months
  lambda.po=12*2 # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=1 # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=0 # Percentage of the final price that is paid during the development of the project
  final.charge.rate=0 # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=0 # Percentaje of the price of the project to be charged monthly for project maintenance

value.landings <- getProjectPresentValue(
  t=t, # Lifetime of the company
  # Mexican economy
  y=y, # Annual interest rate
  r=r, # Inflation rate
  # Princing of the project
  average.price=average.price, # Expected price of the project
  sd.price=sd.price, # Standar deviation of the price of the project
  minimum.price=minimum.price, # Minimum price accepted for the project
  average.development.months=average.development.months, # Expected development time of the project measured in months
  lambda.po=lambda.po, # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=advance.charge.rate, # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=during.development.charge.rate, # Percentage of the final price that is paid during the development of the project
  final.charge.rate=final.charge.rate, # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=monthly.rent.rate # Percentaje of the price of the project to be charged monthly for project maintenance
)
```

Landing pages will arrive to the company with a ratio of $`r lambda.po`$ per year and will consider the following assumptions:

\begin{itemize}
\item The price of a landing page will be $\$`r average.price`.00$ MNX in average with a standar deviation of $\$`r sd.price`.00$ MNX.
\item The average development time of a landing page will be $`r average.development.months`$ month.
\item $`r advance.charge.rate`\times 100$ percent of the project will be charged in advance.
\end{itemize}

\section{Small projects}

```{r small projects assumptions}
  t=10 # Lifetime of the company
  # Mexican economy
  y=0.1 # Annual interest rate
  r=-0.02 # Inflation rate
  # Princing of the project
  average.price=50000 # Expected price of the project
  sd.price=20000 # Standar deviation of the price of the project
  minimum.price=25000 # Minimum price accepted for the project
  average.development.months=4 # Expected development time of the project measured in months
  lambda.po=5 # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=0.25 # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=0.5 # Percentage of the final price that is paid during the development of the project
  final.charge.rate=0.25 # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=0.05 # Percentaje of the price of the project to be charged monthly for project maintenance

value.small.projects <- getProjectPresentValue(
  t=t, # Lifetime of the company
  # Mexican economy
  y=y, # Annual interest rate
  r=r, # Inflation rate
  # Princing of the project
  average.price=average.price, # Expected price of the project
  sd.price=sd.price, # Standar deviation of the price of the project
  minimum.price=minimum.price, # Minimum price accepted for the project
  average.development.months=average.development.months, # Expected development time of the project measured in months
  lambda.po=lambda.po, # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=advance.charge.rate, # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=during.development.charge.rate, # Percentage of the final price that is paid during the development of the project
  final.charge.rate=final.charge.rate, # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=monthly.rent.rate # Percentaje of the price of the project to be charged monthly for project maintenance
)
```

Small projects will arrive to the company with a ratio of $`r lambda.po`$ per year and will consider the following assumptions:

\begin{itemize}
\item The price of a small project will be $\$`r average.price`.00$ MNX in average with a standar deviation of $\$`r sd.price`.00$ MNX.
\item The average development time of a small project will be $`r average.development.months`$ months.
\item $`r advance.charge.rate`\times 100$ percent of the project will be charged in advance.
\item $`r during.development.charge.rate`\times 100$ percent of the project will be charged monthly during the development.
\item $`r final.charge.rate`\times 100$ percent of the project will be charged when the project is finished.
\item $`r monthly.rent.rate`\times 100$ percent of the total price will be charged monthly for project maintenance.
\end{itemize}

\section{Large projects}

```{r large projects assumptions}
  t=10 # Lifetime of the company
  # Mexican economy
  y=0.1 # Annual interest rate
  r=-0.02 # Inflation rate
  # Princing of the project
  average.price=200000 # Expected price of the project
  sd.price=70000 # Standar deviation of the price of the project
  minimum.price=100000 # Minimum price accepted for the project
  average.development.months=7 # Expected development time of the project measured in months
  lambda.po=2 # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=0.25 # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=0.5 # Percentage of the final price that is paid during the development of the project
  final.charge.rate=0.25 # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=0.05 # Percentaje of the price of the project to be charged monthly for project maintenance

value.large.projects <- getProjectPresentValue(
  t=t, # Lifetime of the company
  # Mexican economy
  y=y, # Annual interest rate
  r=r, # Inflation rate
  # Princing of the project
  average.price=average.price, # Expected price of the project
  sd.price=sd.price, # Standar deviation of the price of the project
  minimum.price=minimum.price, # Minimum price accepted for the project
  average.development.months=average.development.months, # Expected development time of the project measured in months
  lambda.po=lambda.po, # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=advance.charge.rate, # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=during.development.charge.rate, # Percentage of the final price that is paid during the development of the project
  final.charge.rate=final.charge.rate, # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=monthly.rent.rate # Percentaje of the price of the project to be charged monthly for project maintenance
)
```

Large projects will arrive to the company with a ratio of $`r lambda.po`$ per year and will consider the following assumptions:

\begin{itemize}
\item The price of a large project will be $\$`r average.price`.00$ MNX in average with a standar deviation of $\$`r sd.price`.00$ MNX .
\item The average development time of a large project will be $`r average.development.time`$.
\item $`r advance.charge.rate`\times 100$ percent of the project will be charged in advance.
\item $`r during.development.charge.rate`\times 100$ percent of the project will be charged monthly during the development.
\item $`r final.charge.rate`\times 100$ percent of the project will be charged when the project is finished.
\item $`r monthly.rent.rate`\times 100$ percent of the total price will be charged monthly for project maintenance.
\end{itemize}

\section{Enterprise projects}

```{r Enterprice projects assumptions}
  t=10 # Lifetime of the company
  # Mexican economy
  y=0.1 # Annual interest rate
  r=-0.02 # Inflation rate
  # Princing of the project
  average.price=1600000 # Expected price of the project
  sd.price=200000 # Standar deviation of the price of the project
  minimum.price=500000 # Minimum price accepted for the project
  average.development.months=13 # Expected development time of the project measured in months
  lambda.po=1 # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=0.25 # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=0.5 # Percentage of the final price that is paid during the development of the project
  final.charge.rate=0.25 # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=0.05 # Percentaje of the price of the project to be charged monthly for project maintenance

value.enterprice.projects <- getProjectPresentValue(
  t=t, # Lifetime of the company
  # Mexican economy
  y=y, # Annual interest rate
  r=r, # Inflation rate
  # Princing of the project
  average.price=average.price, # Expected price of the project
  sd.price=sd.price, # Standar deviation of the price of the project
  minimum.price=minimum.price, # Minimum price accepted for the project
  average.development.months=average.development.months, # Expected development time of the project measured in months
  lambda.po=lambda.po, # Expected number of projects developed in a year
  # Payment scheme
  advance.charge.rate=advance.charge.rate, # Percentage of the final price that is paid at the begining of the project
  during.development.charge.rate=during.development.charge.rate, # Percentage of the final price that is paid during the development of the project
  final.charge.rate=final.charge.rate, # Percentage of the final price that is paid at the end of the development of the project
  monthly.rent.rate=monthly.rent.rate # Percentaje of the price of the project to be charged monthly for project maintenance
)
```

Enterprice projects will arrive to the company with a ratio of $`r lambda.po`$ per year and will consider the following assumptions:

\begin{itemize}
\item The price of an enterprice project will be $\$`r average.price`.00$ MNX in average with a standar deviation of $\$`r sd.price`.00$ MNX.
\item The average development time of an enterprice project will be $`r average.development.time`$.
\item $`r advance.charge.rate`\times 100$ percent of the project will be charged in advance.
\item $`r during.development.charge.rate`\times 100$ percent of the project will be charged monthly during the development.
\item $`r final.charge.rate`\times 100$ percent of the project will be charged when the project is finished.
\item $`r monthly.rent.rate`\times 100$ percent of the total price will be charged monthly for project maintenance.
\end{itemize}

\section{Inhouse projects}

```{r inhouse projects assumptions}
  t=10 # Lifetime of the company
  # Mexican economy
  y=0.1 # Annual interest rate
  r=-0.02 # Inflation rate
  # Project details
  lambda.po=5 # Expected number of projects developed in a year
  average.development.months=14 # Expected development time of the project measured in months
  # Revenue scheme
  average.monthly.rent=400000 # Expected value of the monthly rent that the project will generate
  sd.monthly.rent=100000 # Standar deviation of the monthly rent that the project will generate

value.inhouse.projects <- getInhouseProjectPresentValue(
  t=t, # Lifetime of the company
  # Mexican economy
  y=y, # Annual interest rate
  r=r, # Inflation rate
  # Project details
  lambda.po=lambda.po, # Expected number of projects developed in a year
  average.development.months=average.development.months, # Expected development time of the project measured in months
  # Revenue scheme
  average.monthly.rent=average.monthly.rent, # Expected value of the monthly rent that the project will generate
  sd.monthly.rent=sd.monthly.rent # Standar deviation of the monthly rent that the project will generate
)
```

Inhouse projects will arrive to the company with a ratio of $`r lambda.po`$ per year and will consider the following assumptions:

\begin{itemize}
\item The average development time of a project will be $`r average.development.time`$. months. 
\item The revenue generated by an inhouse project will be $\$`r average.monthly.rent`.00$ MNX in average with an standard deviation of $\$`r sd.monthly.rent`.00$ MNX.
\end{itemize}

\section{Valuation}

Considering the previous assumptions the company's value is $\$676,060,485.00$ MNX.

